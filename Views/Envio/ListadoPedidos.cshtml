@model List<JarredsOrderHub.Models.Pedidos>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/Estilos.css" />
<link rel="stylesheet" href="~/css/ListadoPedidos.css" />


<!-- Título principal -->
<h1 class="titulo-tabla">Listado de Pedidos</h1>

<!-- Contenedor de Cards -->
<div class="container-pedido">
@foreach (var pedido in Model)
{
    <div class="card">
        <h3>Pedido @pedido.Id</h3>
            
        <!-- Mostrando los detalles de cada pedido -->
        @if (pedido.Detalles != null)
        {
            @foreach (var detalle in pedido.Detalles)
            {
                <p>
                    <i class="fas fa-utensils"></i>
                    <span class="bold-text">Plato:</span> @detalle.Platillo?.Nombre
                </p>
                <p>
                    <i class="fas fa-sort-numeric-up-alt"></i>
                    <span class="bold-text">Cantidad:</span> @detalle.Cantidad
                </p>
            }
        }
        else
        {
            <p>No tiene detalles</p>
        }
            
        <p>
            <i class="fas fa-comment"></i>
            <span class="bold-text">Comentarios:</span> @pedido.Comentarios
        </p>
            
        <label for= "estado-@pedido.Id">
            <span class="bold-text">Estado:</span>
        </label>
            
    @{
        var pendienteSelected = pedido.EstadoPedido.ToLower() == "pendiente" ? " selected=\"selected\"" : "";
        var preparandoSelected = pedido.EstadoPedido.ToLower() == "preparando" ? " selected=\"selected\"" : "";
        var enCaminoSelected = pedido.EstadoPedido.ToLower() == "en_camino" ? " selected=\"selected\"" : "";
        var entregadoSelected = pedido.EstadoPedido.ToLower() == "entregado" ? " selected=\"selected\"" : "";
    }
            <select id="estado-@pedido.Id" class="status-dropdown">
                @if (pedido.EstadoPedido.ToLower() == "pendiente")
                {
                    <option value="pendiente" selected>Pendiente</option>
                }
                else
                {
                    <option value="pendiente">Pendiente</option>
                }

                @if (pedido.EstadoPedido.ToLower() == "preparando")
                {
                    <option value="preparando" selected>Preparando</option>
                }
                else
                {
                    <option value="preparando">Preparando</option>
                }

                @if (pedido.EstadoPedido.ToLower() == "en_camino")
                {
                    <option value="en_camino" selected>En Camino</option>
                }
                else
                {
                    <option value="en_camino">En Camino</option>
                }

                @if (pedido.EstadoPedido.ToLower() == "entregado")
                {
                    <option value="entregado" selected>Entregado</option>
                }
                else
                {
                    <option value="entregado">Entregado</option>
                }
            </select>

            
        <!-- Botón para guardar el estado -->
        <button class="save-button" onclick="guardarEstado(@pedido.Id)">Guardar Estado</button>
    </div>
}
</div>

<div style="margin: 40px 0;"></div>

<script>
    //Función para actualizar el estado del pedido
    function guardarEstado(pedidoId) {

        // Se obtiene el dropdown del estado del pedido
        const dropdown = document.getElementById(`estado-${pedidoId}`);
        const nuevoEstado = dropdown.value;

        // Enviar la actualización al backend
        fetch(`/api/PedidosService/actualizarEstado/${pedidoId}/${nuevoEstado}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: null
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Error en la actualización');
            })
            .then(data => {
                alert(`El estado del Pedido #${pedidoId} ha sido actualizado a: ${nuevoEstado}`);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Hubo un error al actualizar el estado.');
            });
    }
</script>

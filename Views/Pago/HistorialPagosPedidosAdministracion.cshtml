@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/Estilos.css" />
<link rel="stylesheet" href="~/css/dataTable.css" />
<link rel="stylesheet" href="~/css/AdminPagos.css" />
@model List<Pago>

    <h1 class="titulo-tabla"> Historial de Pagos</h1>

<div class="contenedor-tabla">

    <!-- Tabla de pagos -->
    <table id="tabla" class="tabla-pagos">
        <thead>
            <tr>
                <th>Pedido ID</th>
                <th>Fecha de Pedido</th>
                <th>Total</th>
                <th>Pago ID</th>
                <th>Monto</th>
                <th>Fecha de Pago</th>
                <th>Método de Pago</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tablaPagosBody">
            @foreach (var pago in Model)
            {
                <tr class="pago-card"
                    data-fecha="@pago.Pedido.FechaPedido.ToString("yyyy-MM-dd")"
                    data-metodopago="@pago.Pedido.MetodoPago">
                    <td>@pago.PedidoId</td>
                    <td>@pago.Pedido.FechaPedido.ToString("yyyy-MM-dd")</td>
                    <td>@pago.Pedido.Total</td>
                    <td>@pago.Id</td>
                    <td>@pago.Monto</td>
                    <td>@pago.FechaPago</td>
                    <td>@pago.Pedido.MetodoPago</td>
                    <td>@pago.Estado</td>
                    <td>
                        <button onclick="verDetalles(@pago.PedidoId)">
                            <i class="fas fa-eye"></i> Ver Detalles
                        </button>
                        <button onclick="reenviarFactura(@pago.PedidoId)">
                            <i class="fas fa-envelope"></i> Reenviar Factura
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

</div>
<!-- Modal de Detalles del Pedido -->
<div id="modalDetalles" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Detalles del Pedido</h2>
            <span class="close" onclick="cerrarModal()">&times;</span>
        </div>
        <p id="detallesPedido"></p>
    </div>
</div>

<!-- Modal para reenviar factura -->
<div id="modalReenviarFactura" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Reenviar Factura</h2>
            <span class="close" onclick="cerrarModal()">&times;</span>
        </div>
        <p id="reenviarMensaje"></p>
        <button onclick="reenviarFacturaConfirmado()">Enviar Factura</button>
    </div>
</div>

  <!-- Incluir jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <!-- Incluir DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>


<script>
    function aplicarFiltros() {
        // Obtener los valores de los filtros
        const fechaInicio = document.getElementById("fechaInicio").value;
        const fechaFin = document.getElementById("fechaFin").value;
        const metodoPago = document.getElementById("metodoPago").value;
        const estadoPago = document.getElementById("estadoPago").value;

        // Obtener todas las filas de la tabla
        const filas = document.querySelectorAll(".tabla-pagos tbody tr");

        filas.forEach(fila => {
            // Obtener los valores de cada fila
            const fechaPedido = fila.querySelector("td:nth-child(2)").innerText;
            const metodo = fila.querySelector("td:nth-child(7)").innerText;
            const estado = fila.querySelector("td:nth-child(8)").innerText;
            const fechaPago = fila.querySelector("td:nth-child(6)").innerText;

            // Inicializar un flag para determinar si la fila debe mostrarse
            let mostrarFila = true;

            // Filtro por fecha de inicio
            if (fechaInicio && new Date(fechaPedido) < new Date(fechaInicio)) {
                mostrarFila = false;
            }

            // Filtro por fecha de fin
            if (fechaFin && new Date(fechaPedido) > new Date(fechaFin)) {
                mostrarFila = false;
            }

            // Filtro por método de pago
            if (metodoPago && metodo !== metodoPago) {
                mostrarFila = false;
            }

            // Filtro por estado de pago
            if (estadoPago && estado !== estadoPago) {
                mostrarFila = false;
            }

            // Mostrar u ocultar la fila según los filtros
            fila.style.display = mostrarFila ? "" : "none";
        });
    }


    // Función para ver detalles del pedido
    function verDetalles(pedidoId) {
        fetch(`/api/PedidosService/Detalles/${pedidoId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("No se encontraron detalles para este pedido.");
                }
                return response.json();
            })
            .then(detalles => {
                let contenido = `Detalles del pedido #${pedidoId}:\n`;

                if (detalles.length > 0) {
                    detalles.forEach(d => {
                        contenido += `- ${d.platillo.nombre} x ${d.cantidad} ($${d.precioUnitario.toFixed(2)})\n`;
                    });

                    const total = detalles.reduce((sum, d) => sum + d.total, 0);
                    contenido += `Total: $${total.toFixed(2)}`;
                } else {
                    contenido += "No hay detalles disponibles.";
                }

                document.getElementById("detallesPedido").innerText = contenido;
                document.getElementById("modalDetalles").style.display = "block";
            })
            .catch(error => {
                document.getElementById("detallesPedido").innerText = error.message;
                document.getElementById("modalDetalles").style.display = "block";
            });
    }

    // Función para reenviar la factura
    function reenviarFactura(pedidoId) {
        let mensaje = `¿Deseas reenviar la factura del pedido #${pedidoId}?`;
        document.getElementById("reenviarMensaje").innerText = mensaje;
        document.getElementById("modalReenviarFactura").style.display = "block";
    }

    // Función para confirmar el envío de la factura
    function reenviarFacturaConfirmado() {
        alert("Factura reenviada exitosamente!");
        cerrarModal();
    }

    // Función para cerrar el modal
    function cerrarModal() {
        document.getElementById("modalDetalles").style.display = "none";
        document.getElementById("modalReenviarFactura").style.display = "none";
    }

    window.onclick = function (event) {
        if (event.target == document.getElementById("modalDetalles") || event.target == document.getElementById("modalReenviarFactura")) {
            cerrarModal();
        }
    }

    $('#tabla').DataTable({
        "order": [[0, "asc"]],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
        },
        "dom": "<'dataTables_wrapper'<'dataTables_top'<'dataTables_length'l><'dataTables_filter'f>>r>t<'dataTables_bottom'<'dataTables_info'i><'dataTables_paginate'p>>",
        "responsive": true,
        "autoWidth": false,
        "initComplete": function (settings, json) {
            // Añadir clase personalizada a los inputs
            $('.dataTables_filter input').addClass('search-input');
            $('.dataTables_length select').addClass('custom-select');
        },
        "columnDefs": [{
            "orderable": true,
            "targets": '_all'
        }],
        "drawCallback": function (settings) {
            // Ajustar posición de la paginación después de dibujar
            $('.dataTables_paginate').css({
                'display': 'flex',
                'justify-content': 'center',
                'width': '100%'
            });
        }
    });


</script>

@model IEnumerable<JarredsOrderHub.Models.Pedidos>
@{
    ViewBag.Title = "Historial de Pedidos";
}
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="~/css/Estilos.css" />
<body>
    <h1 class="titulo-tabla">Historial de Pedidos</h1>
    <table class="employeeTable">
        <thead>
            <tr>
                <th>Pedido ID</th>
                <th>Usuario</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Método de Pago</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var pedido in Model)
            {
                <tr>
                    <td>@pedido.Id</td>
                    <td>
                        @if (pedido.Cliente != null)
                        {
                            <text>@($"{pedido.Cliente.Nombre} {pedido.Cliente.Apellido}")</text>
                        }
                        else
                        {
                            <span>Sin información</span>
                        }
                    </td>
                    <td>@pedido.FechaPedido.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@pedido.EstadoPedido</td>
                    <td>@pedido.MetodoPago</td>
                    <td>@pedido.Total.ToString("C", new System.Globalization.CultureInfo("es-CR"))</td>
                    <td>
                        <a href="javascript:void(0);" onclick="mostrarDetalles(@pedido.Id)" class="btn btn-info btn-sm">
                            Detalles
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Modal para mostrar detalles del pedido -->
    <div id="detallesPedidoModal" class="modal-detallePedido">
        <div class="modal-detallePedido-content">
            <span class="modal-detallePedido-close" onclick="cerrarModal()">&times;</span>
            <div class="modal-detallePedido-header">
                <h2>Detalles del Pedido #<span id="pedidoIdModal"></span></h2>
            </div>
            <div class="modal-detallePedido-body">
                <div class="card-detallePedido-info">
                    <div id="pedidoInfoCard">
                        <!-- Información general del pedido -->
                    </div>
                </div>
                <h3 class="titulo-detallePedido-productos">Productos</h3>
                <div id="detallesPedidoContenido" class="cards-detallePedido-container">
                    <!-- Aquí se cargarán los detalles del pedido en formato de cards -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función para mostrar el modal con los detalles del pedido
        function mostrarDetalles(pedidoId) {
            var modal = document.getElementById('detallesPedidoModal');
            document.getElementById('pedidoIdModal').textContent = pedidoId;

            // Realizar la solicitud AJAX para obtener los detalles
            fetch(`/Pago/ObtenerDetallesPedido/${pedidoId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al obtener los detalles');
                    }
                    return response.json();
                })
                .then(data => {
                    var contenido = document.getElementById('detallesPedidoContenido');
                    contenido.innerHTML = '';

                    // Total acumulado para mostrarlo en el resumen
                    let totalPedido = 0;

                    // Crear cards para cada detalle
                    data.forEach(detalle => {
                        // Acumular el total
                        totalPedido += detalle.total;

                        // Crear card
                        var card = document.createElement('div');
                        card.className = 'card-detallePedido-item';

                        // Contenido de la card
                        card.innerHTML = `
                                    <div class="card-detallePedido-header">
                                        <h4>${detalle.nombrePlatillo}</h4>
                                    </div>
                                    <div class="card-detallePedido-body">
                                        <div class="card-detallePedido-info">
                                            <p><strong>Cantidad:</strong> ${detalle.cantidad}</p>
                                            <p><strong>Precio:</strong> ${formatCurrency(detalle.precioUnitario)}</p>
                                            <p class="total-detallePedido"><strong>Total:</strong> ${formatCurrency(detalle.total)}</p>
                                        </div>
                                    </div>
                                `;

                        contenido.appendChild(card);
                    });

                    // Crear card informativa del pedido
                    var pedidoInfo = document.getElementById('pedidoInfoCard');
                    pedidoInfo.innerHTML = `
                                <div class="info-detallePedido-row">
                                    <div class="info-detallePedido-column">
                                        <p><strong>Número de productos:</strong> ${data.length}</p>
                                        <p><strong>Total del pedido:</strong> ${formatCurrency(totalPedido)}</p>
                                    </div>
                                </div>
                            `;

                    // Mostrar el modal
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar los detalles del pedido.');
                });
        }

        // Función para cerrar el modal
        function cerrarModal() {
            document.getElementById('detallesPedidoModal').style.display = 'none';
        }

        // Función para formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CR', { style: 'currency', currency: 'CRC' }).format(value);
        }

        // Cerrar el modal si se hace clic fuera de él
        window.onclick = function (event) {
            var modal = document.getElementById('detallesPedidoModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        $('#tabla').DataTable({
            "order": [[0, "asc"]],
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
            },
            "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
            "responsive": true,
            "autoWidth": false,
            "initComplete": function (settings, json) {
                // Añadir clase personalizada a los inputs
                $('.dataTables_filter input').addClass('search-input');
                $('.dataTables_length select').addClass('custom-select');
            }
        });
    </script>
